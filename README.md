# Написание bash-скриптов

Ранее мы изучили основные команды, необходимые для работы с интерпретатором командной строки `bash` в интерактивном режиме.

Довольно часто возникает необходимость выполнять какую-либо последовательность команд несколько раз. В таких случаях удобно записать эти команды в сценарий (скрипт) и вызывать их как программу.

Скрипт представляет собой обычный текстовый файл. Традиционно скрипты имеют расширение `.sh`, но это не обязательно.

В простейшем случае интерпретатор просто исполнит по-очереди команды, записанные в этом файле. Для комментариев используется символ `#` (закомментированные строки исполняться не будут).

```bash
echo Hello World
# предыдущая строка выведет на экран Hello World, а эта исполняться не будет
```

Также вы можете писать несколько команд в одну строку, разделяя их точкой с запятой:
```bash
echo Hello; echo world
```

Чтобы дать понять загрузчику программ, что файл скрипта должен интерпретироваться с помощью `bash`, нужно поместить в начало файла [шебанг](
https://ru.wikipedia.org/wiki/%D0%A8%D0%B5%D0%B1%D0%B0%D0%BD%D0%B3_(Unix))
```bash
#! /usr/bin/env bash
```
Самим интерпретатором данная строка будет игнорироваться, так как является комментарием (начинается с символа `#`)

Для исполнения файла в Unix-подобных операционных системах (будь то бинарный код или скрипт) требуется, чтобы у файла были установлены права на исполнение. Изменение прав доступа осуществляется утилитой `chmod`. Более подробно о правах доступа к файлам в Unix можно прочитать на [Wikipedia](https://ru.wikipedia.org/wiki/Chmod). Для того, чтобы установить нужные права на ваш скрипт, просто выполните:
```console
$ chmod +x my_script.sh
```

Если этого не сделать, bash сообщит вам об отказе в доступе:
```console
$ ./test.sh
-bash: ./test.sh: Permission denied
```

Обратите также внимание, что для запуска скрипта требуется указать путь к нему. `./` перед именем файла означает, что файл находится в текущем каталоге. Если путь к файлу не указан, будет произведён поиск программы в каталогах, указанных в переменной окружения `PATH` (об этом ниже).

> ### Задание 1.
> Создайте файл `task1.sh` который бы при запуске выводил на экран строку “Hello world”.

Как и в других языках программирования, в bash-скриптах можно задавать переменные. Но синтаксис задания и обращения к переменным в bash немного необычен. По традиции переменные называются обычно прописными буквами.
Чтобы задать переменную MY_VAR:
```bash
MY_VAR=”World”
```

Обратите внимание на расстановку пробелов: вокруг знака равенства их быть не должно. Проверьте, какие ошибки возникают, если нарушить это правила, и избегайте их в будущем.

Для подстановки значения переменной используется знак `$`:
```bash
echo “Hello $MY_VAR”
# выведет Hello World
```

Проверьте, как измениться вывод команды, если в последней команде заменить двойные кавычки на одинарные. 

Если требуется явно указать, где заканчивается имя переменной, и начинается обычный текст, можно использовать фигурный скобки:
```
echo “${MY_VAR}111”
```

Существуют так называемые переменные окружения, в которых хранятся некоторые параметры системы. Например, одной из таких переменных окружения является `PATH`, в ней записаны адреса каталогов, в которых происходит поиск исполняемых файлов. Распечатайте переменную `PATH` и ознакомьтесь с содержимым каталогов, перечисленных в ней.

Некоторые специальные переменные позволяют обращаться к параметрам скрипта, передаваемым ему через аргументы командной строки:
`$#` — позволяет получить количество аргументов скрипта
от `$1` до `$9` и далее `${10}`, `${11}`... — аргументы, переданные скрипту.

Не следует путать фигурные и круглые скобки. В bash выражение `$(command)` будет означать подстановку результата выполнения команды `command`:
```bash
$ echo “Вывод команды ls: $(ls)”
```

> ### Задание 2.
> Создайте файл `task2.sh` который бы в качестве аргумента принимал имя, и выводил на экран “Hello, имя!”. Например:
> 
> ```console
> $ task2.sh World
> Hello, World!
> ```

Кроме обычных команд, в скрипте могут присутствовать специальные конструкции, позволяющие реализовать условия и циклы. На самом деле, эти конструкции можно использовать не только в скриптах, но и при работе с bash в интерактивном режиме.

Условия записываются следующим образом:
```
if [[ УСЛОВИЕ ]]
then
    # Выполняется, если условие истинно
else
    # Выполняется в противоположном случае
fi
```

Ознакомьтесь с кратким перечнем условий, которые поддерживает bash: https://devhints.io/bash#conditionals

Циклы в bash бывают нескольких видов.

Цикл `for`:
```bash
for i in {1..10}; do
  echo $i
done
```
Код выше распечатает цифры от 1 до 10. Другой вариант записать то же самое, в стиле языка Си:
```bash
for ((i = 0 ; i < 10 ; i++)); do
  echo $i
done
```

Цикл `for` часто используется для того, чтобы итерироваться по файлам внутри определённого каталога:
```bash
for i in /etc/rc.*; do
  echo $i
done
```
Также он позволяет итерироваться по строками из вывода определенной команды (как `ls` в примере ниже). Кроме того, этот пример показывает как используя точку с запятой можно записывать цикл в одну строку, так что вы можете без проблем запустить её прямо из терминала:
```bash
for i in $(ls); do echo $i; done
```

`while` позволяет описывать бесконечный цикл. Для выхода из такого цикла по определенному условию используйте `break`:
```bash
while true; do
  ...
  # do something
  if [[ ... ]] then
    break
  fi
done
```

> ### Задание 3.
> Написать скрипт `task3.sh`, который бы принимал три аргумента:
> 1. имя файла
> 2. текст
> 3. количество повторений.
> 
> Если файл с указанным именем уже существует — вывести ошибку.
> В остальных случаях, вывести в файл переданный текст указанное количество раз. Например:
> 
> ```console
> $ ./repeat_str.sh test.txt test 3
> $ cat test.txt
> test
> test
> test
> $ ./repeat_str.sh test.txt test 3
> Error: File “test.txt” already exists
> ```

Вы ознакомились с основными конструкциями, которые используются в скриптах командной оболочки bash. Bash имеет множество недостатков, среди которых специфический неконсистентный синтаксис, привередливость к расстановке пробелов, и т.д., поэтому для программирования какой-то сложной логики следует обратиться к другим скриптовым языкам, вроде Python. Однако в том, что касается автоматизации небольших рутинных операций с файлами, bash может быть весьма полезен.

Справочная литература:
* Краткий справочник по bash: https://devhints.io/bash
* Гайд по оформлению кода на bash от Google: https://google.github.io/styleguide/shellguide.html
